
var http = require('http');
var finder = require('Finder');


/**
 *
 * @param {http.ClientRequest} request
 * @param {ServerResponse} response
 */
function requestHandler(request, response) {
    try {
        finder.get(request.url, (result) => httpSuccess(response, result), (err) => httpError(response, err));
    } catch (e) {
        console.log(e.message);
    }
}
function httpSuccess(response, result) {
    if (!result.type) {
        result.type = "text/plain";
    }
    response.writeHead(200, {
        'Content-Type': result.type
    });

    if (result.stream) {
        result.stream.on("error", (err) => httpError(response, err)).pipe(response);
    } else if (result.string) {
        response.end(result.string);
    } else if (result.json) {
        response.end(JSON.stringify(result.json, null, 2));
    }
}
function httpError(response, err) {
    response.writeHead(404, "Not found");
    response.end("");
}

function start() {
    console.log("Starting WebServer");
    http.createServer(requestHandler).listen(80, "");
}

exports.start = start;